name: Build RPM Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          python3 \
          python3-pip \
          git \
          curl \
          wget \
          rpm \
          rpm-build \
          rpmdevtools \
          libx11-dev \
          libx11-xcb-dev \
          libxcb1-dev \
          libxcb-icccm4-dev \
          libxcb-image0-dev \
          libxcb-keysyms1-dev \
          libxcb-randr0-dev \
          libxcb-render-util0-dev \
          libxcb-render0-dev \
          libxcb-shape0-dev \
          libxcb-shm0-dev \
          libxcb-sync1-dev \
          libxcb-xfixes0-dev \
          libxcb-xinerama0-dev \
          libxcb-xkb-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libfontconfig1-dev \
          libfreetype6-dev \
          libxss1 \
          libasound2-dev \
          libpulse-dev \
          libnss3-dev \
          libnspr4-dev \
          libpci-dev \
          libudev-dev \
          libdrm-dev \
          libgbm-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxdamage-dev \
          libxrandr-dev \
          libxtst-dev \
          libxss-dev \
          libglib2.0-dev \
          libgtk-3-dev \
          libdbus-1-dev \
          libexpat1-dev \
          libgnome-keyring-dev \
          libpango1.0-dev \
          libatk1.0-dev \
          libatspi2.0-dev \
          ninja-build \
          clang \
          lld \
          libc++-dev \
          libc++abi-dev

    - name: Install depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$HOME/depot_tools"
        echo "$HOME/depot_tools" >> $GITHUB_PATH

    - name: Setup gclient config
      run: |
        mkdir -p chromium
        cd chromium
        cat > .gclient <<EOF
solutions = [
  {
    "name": "src",
    "url": "https://chromium.googlesource.com/chromium/src.git",
    "managed": False,
    "custom_deps": {},
    "custom_vars": {
      "checkout_clang": True,
    },
  },
]
EOF

    - name: Sync Chromium source
      run: |
        cd chromium
        export PATH="$PATH:$HOME/depot_tools"
        gclient sync --no-history --shallow

    - name: Install build deps
      run: |
        cd chromium/src
        export PATH="$PATH:$HOME/depot_tools"
        ./build/install-build-deps.sh --no-arm --no-chromeos-fonts --no-nacl

    - name: Generate build files
      run: |
        cd chromium/src
        export PATH="$PATH:$HOME/depot_tools"
        gn gen out/Default --args="
          is_debug=false
          is_component_build=false
          is_clang=true
          use_lld=true
          use_sysroot=false
          treat_warnings_as_errors=false
          enable_nacl=false
          enable_widevine=false
          proprietary_codecs=true
          ffmpeg_branding=\"Chrome\"
          symbol_level=0
          blink_symbol_level=0
          v8_symbol_level=0
        "

    - name: Build Chromium (may fail due to resource limits)
      run: |
        cd chromium/src
        export PATH="$PATH:$HOME/depot_tools"
        ninja -C out/Default chrome

    - name: Create RPM build structure
      run: |
        mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
        cp -r chromium/src/out/Default ~/rpmbuild/BUILD/chromium-clang

    - name: Create RPM spec file
      run: |
        cat > ~/rpmbuild/SPECS/chromium-clang.spec << 'EOF'
Name: chromium-clang
Version: 1.0
Release: 1%{?dist}
Summary: Chromium browser compiled with Clang/LLVM
License: BSD
URL: https://github.com/RobRich999/Chromium_Clang
Source0: %{name}-%{version}.tar.gz

BuildRequires: gcc, make, rpm-build
Requires: libX11, libXcomposite, libXcursor, libXdamage, libXext, libXfixes, libXi, libXrender, libXtst, libXrandr, libXss, alsa-lib, dbus-libs, expat, fontconfig, freetype, glib2, gtk3, libXScrnSaver, nss, nspr, pango, atk, cairo, gdk-pixbuf2, libdrm, mesa-libgbm, systemd-libs

%description
Chromium browser compiled with the Clang/LLVM compiler.

%prep
%setup -q

%build
# Build already completed

%install
rm -rf %{buildroot}
mkdir -p %{buildroot}/usr/bin
mkdir -p %{buildroot}/usr/lib64/chromium-clang
cp -r %{_topdir}/BUILD/chromium-clang/* %{buildroot}/usr/lib64/chromium-clang/
ln -s /usr/lib64/chromium-clang/chrome %{buildroot}/usr/bin/chromium-clang

%files
%license LICENSE
/usr/bin/chromium-clang
/usr/lib64/chromium-clang/*

%changelog
* $(date -R) Builder <builder@example.com> - 1.0-1
- Initial build
EOF

    - name: Build RPM
      run: |
        cd ~/rpmbuild
        rpmbuild -ba SPECS/chromium-clang.spec

    - name: Upload RPM artifacts
      uses: actions/upload-artifact@v3
      with:
        name: chromium-clang-rpm
        path: ~/rpmbuild/RPMS/**/*
        if-no-files-found: ignore

    - name: Upload SRPM
      uses: actions/upload-artifact@v3
      with:
        name: chromium-clang-srpm
        path: ~/rpmbuild/SRPMS/**/*
        if-no-files-found: ignore
