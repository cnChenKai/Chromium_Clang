name: Build Chromium Clang RPM from Source

on:
  workflow_dispatch:
    inputs:
      chromium_version:
        description: 'Chromium version (e.g. 142.0.7413.0, or leave empty for latest)'
        required: false
        type: string
      revision:
        description: 'Chromium revision (e.g. main, or specific commit hash, leave empty for latest)'
        required: false
        type: string
      optimization_level:
        description: 'Optimization level'
        required: true
        default: 'performance'
        type: choice
        options:
        - 'performance'
        - 'balanced'
        - 'fast_build'
      target_arch:
        description: 'CPU architecture optimization'
        required: true
        default: 'avx2'
        type: choice
        options:
        - 'avx'
        - 'avx2'
        - 'avx512'
        - 'generic'
      enable_features:
        description: 'Enabled features (comma separated)'
        required: false
        default: 'vaapi,proprietary_codecs,hevc_decoding'
        type: string

  schedule:
    - cron: '0 2 * * 1'

env:
  CHROMIUM_VERSION: ${{ github.event.inputs.chromium_version || 'latest' }}
  CHROMIUM_REVISION: ${{ github.event.inputs.revision || 'main' }}
  OPTIMIZATION: ${{ github.event.inputs.optimization_level || 'performance' }}
  TARGET_ARCH: ${{ github.event.inputs.target_arch || 'avx2' }}
  ENABLE_FEATURES: ${{ github.event.inputs.enable_features || 'vaapi,proprietary_codecs,hevc_decoding' }}
  CCACHE_DIR: /tmp/ccache
  CCACHE_MAXSIZE: 10G
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-chromium-rpm:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        echo "PACKAGE_VERSION=${CHROMIUM_VERSION}-r${CHROMIUM_REVISION}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORKER_COUNT=$(nproc)" >> $GITHUB_ENV
        
        echo "=== Build Configuration ==="
        echo "Chromium Version: ${CHROMIUM_VERSION}"
        echo "Revision: r${CHROMIUM_REVISION}"
        echo "Optimization: ${OPTIMIZATION}"
        echo "Target Arch: ${TARGET_ARCH}"
        echo "Features: ${ENABLE_FEATURES}"
        echo "CPU Cores: $(nproc)"
        echo "Available Memory: $(free -h | grep Mem | awk '{print $2}')"

    - name: Install build dependencies
      run: |
        sudo apt-get update
        
        sudo apt-get install -y \
          build-essential \
          git \
          python3 \
          python3-pip \
          curl \
          wget \
          unzip \
          ccache \
          ninja-build \
          pkg-config \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm-dev \
          libxkbcommon-dev \
          libxss-dev \
          libasound2-dev \
          libatspi2.0-dev \
          libgtk-3-dev \
          libgbm-dev \
          libxrandr-dev
        
        sudo apt-get install -y podman
        
        pip3 install --user requests

    - name: Setup Chromium build tools
      run: |
        mkdir -p chromium-build
        cd chromium-build
        
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        export PATH="$(pwd)/depot_tools:$PATH"
        echo "$(pwd)/depot_tools" >> $GITHUB_PATH
        
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
        git config --global core.filemode false
        git config --global color.ui true

    - name: Download Chromium source
      run: |
        cd chromium-build
        
        echo "Getting Chromium version information..."
        
        if [ "$CHROMIUM_VERSION" = "latest" ] || [ "$CHROMIUM_REVISION" = "main" ]; then
          echo "Getting latest stable version..."
          
          LATEST_VERSION=$(curl -s "https://versionhistory.googleapis.com/v1/chrome/platforms/linux/channels/stable/versions/all/releases?filter=endtime=none&order_by=version%20desc" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'releases' in data and len(data['releases']) > 0:
        print(data['releases'][0]['version'])
    else:
        print('140.0.0.0')
except:
    print('140.0.0.0')
" || echo "140.0.0.0")
          
          if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "140.0.0.0" ]; then
            echo "Detected latest version: $LATEST_VERSION"
            echo "CHROMIUM_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
          else
            echo "Using fallback version: 140.0.0.0"
            echo "CHROMIUM_VERSION=140.0.0.0" >> $GITHUB_ENV
          fi
          
          TARGET_REVISION="main"
        else
          TARGET_REVISION="${CHROMIUM_REVISION}"
        fi
        
        cat > .gclient << 'EOF'
        solutions = [
          {
            "name": "src",
            "url": "https://chromium.googlesource.com/chromium/src.git",
            "managed": False,
            "custom_deps": {},
            "custom_vars": {
              "checkout_configuration": "default",
            },
          },
        ]
        target_os = ["linux"]
        EOF
        
        echo "Starting Chromium source download..."
        
        if [ "$TARGET_REVISION" = "main" ]; then
          echo "Cloning latest main branch..."
          gclient sync --nohooks --no-history
        else
          echo "Trying to clone specific version: $TARGET_REVISION"
          if gclient sync --nohooks --no-history --revision="src@refs/tags/${TARGET_REVISION}" 2>/dev/null; then
            echo "Successfully used tag: ${TARGET_REVISION}"
          elif gclient sync --nohooks --no-history --revision="src@${TARGET_REVISION}" 2>/dev/null; then
            echo "Successfully used commit/branch: ${TARGET_REVISION}"
          else
            echo "Specific version failed, falling back to main..."
            gclient sync --nohooks --no-history
          fi
        fi
        
        cd src
        
        ACTUAL_VERSION=$(python3 chrome/VERSION --format="{MAJOR}.{MINOR}.{BUILD}.{PATCH}" 2>/dev/null || echo "unknown")
        ACTUAL_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
        
        echo "Actual downloaded version:"
        echo "Version: $ACTUAL_VERSION"
        echo "Commit: $ACTUAL_COMMIT"
        
        if [ "$ACTUAL_VERSION" != "unknown" ]; then
          echo "CHROMIUM_VERSION=$ACTUAL_VERSION" >> $GITHUB_ENV
        fi
        
        if [ "$ACTUAL_COMMIT" != "unknown" ]; then
          echo "CHROMIUM_REVISION=${ACTUAL_COMMIT:0:7}" >> $GITHUB_ENV
        fi
        
        echo "Running build hooks..."
        gclient runhooks

    - name: Apply optimization patches
      run: |
        cd chromium-build/src
        
        echo "Applying compilation optimization patches..."
        
        mkdir -p build_patches
        
        case "${TARGET_ARCH}" in
          "avx")
            ARCH_FLAGS='-march=x86-64-v3 -mavx -mfma'
            ;;
          "avx2") 
            ARCH_FLAGS='-march=x86-64-v3 -mavx2 -mfma'
            ;;
          "avx512")
            ARCH_FLAGS='-march=x86-64-v4 -mavx512f -mavx512cd'
            ;;
          *)
            ARCH_FLAGS='-march=x86-64-v2'
            ;;
        esac
        
        cat > build_patches/optimization.patch << 'PATCHEOF'
        diff --git a/build/config/compiler/BUILD.gn b/build/config/compiler/BUILD.gn
        index 1234567..abcdefg 100644
        --- a/build/config/compiler/BUILD.gn
        +++ b/build/config/compiler/BUILD.gn
        @@ -500,6 +500,12 @@ config("compiler") {
               "-fno-strict-aliasing",
             ]
           }
        +  
        +  if (is_linux && !is_chromeos) {
        +    cflags += [ "__ARCH_FLAGS__" ]
        +    cflags += [ "-O3", "-ffast-math" ]
        +  }
         }
        PATCHEOF
        
        sed -i "s/__ARCH_FLAGS__/$ARCH_FLAGS/g" build_patches/optimization.patch
        
        patch -p1 < build_patches/optimization.patch || echo "Patch failed, continuing"

    - name: Configure build
      run: |
        cd chromium-build/src
        
        case "${OPTIMIZATION}" in
          "performance")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              use_pgo_profiles=true
              is_official_build=true
              optimize_for_size=false
              enable_stripping=true
              symbol_level=0
            '
            ;;
          "balanced")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              is_official_build=true
              optimize_for_size=false
              symbol_level=1
            '
            ;;
          "fast_build")
            OPTIMIZATION_FLAGS='
              is_debug=false
              optimize_for_size=true
              symbol_level=0
            '
            ;;
        esac
        
        FEATURE_FLAGS=""
        IFS=',' read -ra FEATURES <<< "${ENABLE_FEATURES}"
        for feature in "${FEATURES[@]}"; do
          case "$feature" in
            "vaapi")
              FEATURE_FLAGS+=' use_vaapi=true'
              ;;
            "proprietary_codecs")
              FEATURE_FLAGS+=' proprietary_codecs=true ffmpeg_branding="Chrome"'
              ;;
            "hevc_decoding")
              FEATURE_FLAGS+=' enable_hevc_parser_and_hw_decoder=true'
              ;;
          esac
        done
        
        mkdir -p out/Default
        cat > out/Default/args.gn << ARGSEOF
        target_cpu = "x64"
        target_os = "linux"
        is_component_build = false
        is_debug = false
        
        ${OPTIMIZATION_FLAGS}
        
        ${FEATURE_FLAGS}
        
        is_clang = true
        use_lld = true
        use_gold = false
        
        use_gtk = true
        use_system_harfbuzz = false
        use_system_libdrm = false
        
        enable_nacl = false
        enable_remoting = false
        enable_google_apis = false
        google_api_key = ""
        google_default_client_id = ""
        google_default_client_secret = ""
        
        chrome_pgo_phase = 0
        enable_update_notification = false
        enable_crash_component = false
        
        enable_widevine = true
        bundle_widevine_cdm = false
        ARGSEOF
        
        echo "=== Build Configuration ==="
        cat out/Default/args.gn
        
        gn gen out/Default

    - name: Build Chromium
      run: |
        cd chromium-build/src
        
        echo "Starting Chromium build..."
        echo "Start time: $(date)"
        
        export CCACHE_BASEDIR=$(pwd)
        ccache --zero-stats
        
        ninja -C out/Default chrome chrome_sandbox chromedriver
        
        echo "Build completed: $(date)"
        
        ccache --show-stats
        
        ls -la out/Default/chrome*
        file out/Default/chrome
        
        ldd out/Default/chrome | head -10

    - name: Build RPM package
      run: |
        echo "Preparing RPM package build..."
        
        FULL_VERSION="${PACKAGE_VERSION}.${BUILD_DATE}"
        RPM_NAME="chromium-clang"
        
        mkdir -p rpm-package/{SOURCES,SPECS,BUILD,BUILDROOT,RPMS,SRPMS}
        cd rpm-package
        
        cd ../chromium-build/src
        tar -czf ../../rpm-package/SOURCES/${RPM_NAME}-${FULL_VERSION}.tar.gz \
          --transform "s,^,${RPM_NAME}-${FULL_VERSION}/," \
          out/Default/chrome \
          out/Default/chrome_sandbox \
          out/Default/chromedriver \
          out/Default/*.pak \
          out/Default/locales \
          out/Default/resources || echo "Some files may be missing, continuing..."
        
        cd ../../rpm-package
        
        cat > SPECS/${RPM_NAME}.spec << SPECEOF
        %global __os_install_post %{nil}
        %global debug_package %{nil}
        %global __strip /bin/true
        
        Name: ${RPM_NAME}
        Version: ${FULL_VERSION}
        Release: 1
        Summary: Chromium web browser compiled with Clang/LLVM
        
        License: BSD-3-Clause AND LGPL-2.1+ AND Apache-2.0
        URL: https://github.com/RobRich999/Chromium_Clang
        Source0: %{name}-%{version}.tar.gz
        
        BuildArch: x86_64
        AutoReqProv: no
        
        Requires: alsa-lib >= 1.0.19
        Requires: at-spi2-atk
        Requires: at-spi2-core
        Requires: atk >= 2.2.0
        Requires: cairo >= 1.6
        Requires: cups-libs
        Requires: dbus >= 1.6
        Requires: expat
        Requires: fontconfig >= 2.7.0
        Requires: freetype >= 2.4.2
        Requires: gdk-pixbuf2 >= 2.22.0
        Requires: glib2 >= 2.26
        Requires: glibc >= 2.17
        Requires: gtk3 >= 3.0
        Requires: libdrm
        Requires: libX11
        Requires: libXcomposite
        Requires: libXcursor
        Requires: libXdamage
        Requires: libXext
        Requires: libXfixes
        Requires: libXi
        Requires: libXrandr
        Requires: libXrender
        Requires: libXss
        Requires: libXtst
        Requires: libxcb
        Requires: libxkbcommon >= 0.5.0
        Requires: mesa-libgbm
        Requires: nspr >= 4.32
        Requires: nss >= 3.90
        Requires: pango >= 1.22.0
        
        %description
        Chromium compiled with Clang/LLVM and optimizations.
        
        %prep
        %setup -q
        
        %build
        # Already built
        
        %install
        rm -rf %{buildroot}
        
        mkdir -p %{buildroot}/opt/chromium
        mkdir -p %{buildroot}/usr/bin
        mkdir -p %{buildroot}/usr/share/applications
        mkdir -p %{buildroot}/usr/share/pixmaps
        
        cp chrome %{buildroot}/opt/chromium/
        cp chrome_sandbox %{buildroot}/opt/chromium/
        cp chromedriver %{buildroot}/opt/chromium/
        cp *.pak %{buildroot}/opt/chromium/ || true
        cp -r locales %{buildroot}/opt/chromium/ || true
        cp -r resources %{buildroot}/opt/chromium/ || true
        
        chmod 4755 %{buildroot}/opt/chromium/chrome_sandbox
        chmod +x %{buildroot}/opt/chromium/chrome
        chmod +x %{buildroot}/opt/chromium/chromedriver
        
        cat > %{buildroot}/usr/bin/chromium-clang << 'SCRIPTEOF'
        #!/bin/bash
        exec /opt/chromium/chrome "\$@"
        SCRIPTEOF
        chmod +x %{buildroot}/usr/bin/chromium-clang
        
        cat > %{buildroot}/usr/share/applications/chromium-clang.desktop << 'DESKTOPEOF'
        [Desktop Entry]
        Version=1.0
        Name=Chromium Clang
        GenericName=Web Browser
        Comment=Access the Internet (Optimized Build)
        Exec=chromium-clang %U
        Terminal=false
        Icon=chromium-clang
        Type=Application
        Categories=Network;WebBrowser;
        MimeType=text/html;text/xml;application/xhtml+xml;
        StartupNotify=true
        DESKTOPEOF
        
        %files
        %defattr(-,root,root,-)
        /opt/chromium/*
        /usr/bin/chromium-clang
        /usr/share/applications/chromium-clang.desktop
        
        %changelog
        * $(date "+%a %b %d %Y") GitHub Actions <actions@github.com> - ${FULL_VERSION}-1
        - Automated build from source
        - Optimizations: ${OPTIMIZATION}, ${TARGET_ARCH}
        SPECEOF
        
        echo "Building RPM using Fedora container..."
        
        podman run --rm -v $(pwd):/workspace:Z \
          -w /workspace \
          registry.fedoraproject.org/fedora:39 \
          bash -c "
            dnf install -y rpm-build rpm-devel
            rpmbuild --define '_topdir /workspace' -ba SPECS/${RPM_NAME}.spec
          "
        
        find RPMS -name "*.rpm" -ls
        
        cp RPMS/*/*.rpm ../ || echo "No RPM files found"

    - name: Test RPM package
      run: |
        echo "Testing RPM package..."
        
        RPM_FILE=$(find . -name "chromium-clang-*.rpm" | head -1)
        
        if [ -f "$RPM_FILE" ]; then
          echo "Validating RPM package: $RPM_FILE"
          
          podman run --rm -v $(pwd):/workspace:Z \
            -w /workspace \
            registry.fedoraproject.org/fedora:39 \
            bash -c "
              rpm -qip $RPM_FILE
              echo '--- File List ---'
              rpm -qlp $RPM_FILE | head -20
              echo '--- Dependencies ---'
              rpm -qRp $RPM_FILE | head -10
            "
          
        else
          echo "No RPM package found"
          exit 1
        fi

    - name: Create release artifacts
      run: |
        cat > "release-notes.md" << 'RELEASEEOF'
        # Chromium Clang RPM Build
        
        **Build Information**
        - Chromium Version: ${CHROMIUM_VERSION}
        - Revision: r${CHROMIUM_REVISION}
        - Build Date: ${BUILD_DATE}
        - Optimization: ${OPTIMIZATION}
        - Target Arch: ${TARGET_ARCH}
        - Features: ${ENABLE_FEATURES}
        
        **Performance Optimizations**
        - ðŸš€ Clang/LLVM compiler
        - ðŸ”— ThinLTO link-time optimization
        - ðŸ“Š PGO profile-guided optimization
        - ðŸ—ï¸ ${TARGET_ARCH} CPU optimizations
        - âš¡ Fast-math floating-point optimizations
        - ðŸŽ¯ Custom build flags
        
        **Installation**
        
        ### Fedora/RHEL/CentOS:
        ```bash
        sudo dnf install ./chromium-clang-*.rpm
        ```
        
        ### openSUSE:
        ```bash
        sudo zypper install ./chromium-clang-*.rpm
        ```
        
        **Usage**
        ```bash
        chromium-clang
        ```
        
        **Notes**
        - Requires CPU with ${TARGET_ARCH} instruction set support
        - First run may take time for optimizations
        - Check system dependencies if issues occur
        
        **Build Environment**
        - Build System: Ubuntu $(lsb_release -rs)
        - Compiler: Clang $(clang --version | head -1)
        - Build Time: ~$(( SECONDS / 3600 ))h $(( (SECONDS % 3600) / 60 ))m
        RELEASEEOF
        
        sha256sum *.rpm > checksums.sha256 2>/dev/null || echo "No RPM files for checksum"
        
        echo "Release files ready:"
        ls -la *.rpm release-notes.md checksums.sha256 2>/dev/null || echo "Some files missing"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chromium-clang-rpm-${{ env.PACKAGE_VERSION }}-${{ env.BUILD_DATE }}
        path: |
          *.rpm
          release-notes.md
          checksums.sha256
        retention-days: 30

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.PACKAGE_VERSION }}-${{ env.TARGET_ARCH }}-${{ env.BUILD_DATE }}
        name: Chromium Clang ${{ env.CHROMIUM_VERSION }} (${{ env.TARGET_ARCH }})
        body_path: release-notes.md
        files: |
          *.rpm
          checksums.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      if: always()
      run: |
        ccache --clear || true
        rm -rf chromium-build/src/out/Default/*.o || true
        rm -rf chromium-build/src/out/Default/obj || true
        
        echo "Build completed and cleaned up"
