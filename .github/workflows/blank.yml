name: Build Chromium Clang RPM from Source

on:
  workflow_dispatch:
    inputs:
      chromium_version:
        description: 'Chromium ç‰ˆæœ¬ (ä¾‹å¦‚: 142.0.7413.0)'
        required: true
        type: string
      revision:
        description: 'Chromium revision (ä¾‹å¦‚: 1515249)'
        required: true
        type: string
      optimization_level:
        description: 'ä¼˜åŒ–çº§åˆ«'
        required: true
        default: 'performance'
        type: choice
        options:
        - 'performance'  # æœ€é«˜æ€§èƒ½
        - 'balanced'     # å¹³è¡¡æ€§èƒ½å’Œæ„å»ºæ—¶é—´
        - 'fast_build'   # å¿«é€Ÿæ„å»º
      target_arch:
        description: 'CPU æ¶æ„ä¼˜åŒ–'
        required: true
        default: 'avx2'
        type: choice
        options:
        - 'avx'
        - 'avx2'
        - 'avx512'
        - 'generic'
      enable_features:
        description: 'å¯ç”¨çš„ç‰¹æ€§ (é€—å·åˆ†éš”)'
        required: false
        default: 'vaapi,proprietary_codecs,hevc_decoding'
        type: string

  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹æ£€æŸ¥æ„å»º

env:
  # æ„å»ºé…ç½®
  CHROMIUM_VERSION: ${{ github.event.inputs.chromium_version || '142.0.7413.0' }}
  CHROMIUM_REVISION: ${{ github.event.inputs.revision || '1515249' }}
  OPTIMIZATION: ${{ github.event.inputs.optimization_level || 'performance' }}
  TARGET_ARCH: ${{ github.event.inputs.target_arch || 'avx2' }}
  ENABLE_FEATURES: ${{ github.event.inputs.enable_features || 'vaapi,proprietary_codecs,hevc_decoding' }}
  
  # ç¼–è¯‘ç¯å¢ƒ
  CCACHE_DIR: /tmp/ccache
  CCACHE_MAXSIZE: 10G
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-chromium-rpm:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 å°æ—¶è¶…æ—¶
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        # è®¾ç½®å˜é‡
        echo "PACKAGE_VERSION=${CHROMIUM_VERSION}-r${CHROMIUM_REVISION}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORKER_COUNT=$(nproc)" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        echo "=== æ„å»ºé…ç½® ==="
        echo "Chromium ç‰ˆæœ¬: ${CHROMIUM_VERSION}"
        echo "ä¿®è®¢ç‰ˆæœ¬: r${CHROMIUM_REVISION}"
        echo "ä¼˜åŒ–çº§åˆ«: ${OPTIMIZATION}"
        echo "ç›®æ ‡æ¶æ„: ${TARGET_ARCH}"
        echo "å¯ç”¨ç‰¹æ€§: ${ENABLE_FEATURES}"
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        echo "å¯ç”¨å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"

    - name: Install build dependencies
      run: |
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        sudo apt-get update
        
        # å®‰è£…åŸºç¡€æ„å»ºå·¥å…·
        sudo apt-get install -y \
          build-essential \
          git \
          python3 \
          python3-pip \
          curl \
          wget \
          unzip \
          ccache \
          ninja-build \
          pkg-config \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm-dev \
          libxkbcommon-dev \
          libxss-dev \
          libasound2-dev \
          libatspi2.0-dev \
          libgtk-3-dev \
          libgbm-dev \
          libxrandr-dev
        
        # ä½¿ç”¨ Fedora å®¹å™¨æ¥æ„å»º RPM (æ›´å¯é çš„æ–¹æ¡ˆ)
        sudo apt-get install -y podman
        
        # è®¾ç½® Python ä¾èµ–
        pip3 install --user requests

    - name: Setup Chromium build tools
      run: |
        # åˆ›å»ºå·¥ä½œç›®å½•
        mkdir -p chromium-build
        cd chromium-build
        
        # ä¸‹è½½ depot_tools
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        export PATH="$(pwd)/depot_tools:$PATH"
        echo "$(pwd)/depot_tools" >> $GITHUB_PATH
        
        # é…ç½® Gitï¼ˆdepot_tools éœ€è¦ï¼‰
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
        git config --global core.filemode false
        git config --global color.ui true

    - name: Download Chromium source
      run: |
        cd chromium-build
        
        # åˆ›å»º gclient é…ç½®
        cat > .gclient << EOF
        solutions = [
          {
            "name": "src",
            "url": "https://chromium.googlesource.com/chromium/src.git",
            "managed": False,
            "custom_deps": {},
            "custom_vars": {
              "checkout_configuration": "default",
            },
          },
        ]
        target_os = ["linux"]
        EOF
        
        # åŒæ­¥æºç åˆ°ç‰¹å®šç‰ˆæœ¬
        echo "å¼€å§‹ä¸‹è½½ Chromium æºç ..."
        gclient sync --nohooks --no-history --revision=src@${CHROMIUM_REVISION}
        
        cd src
        # è¿è¡Œæ„å»ºå‰çš„é’©å­
        gclient runhooks

    - name: Apply optimization patches
      run: |
        cd chromium-build/src
        
        # åº”ç”¨æ¥è‡ª RobRich999 é¡¹ç›®çš„ä¼˜åŒ–è¡¥ä¸
        echo "åº”ç”¨ç¼–è¯‘ä¼˜åŒ–è¡¥ä¸..."
        
        # åˆ›å»ºä¼˜åŒ–è¡¥ä¸ç›®å½•
        mkdir -p build_patches
        
        # CPU æ¶æ„ä¼˜åŒ–
        case "${TARGET_ARCH}" in
          "avx")
            ARCH_FLAGS='-march=x86-64-v3 -mavx -mfma'
            ;;
          "avx2") 
            ARCH_FLAGS='-march=x86-64-v3 -mavx2 -mfma'
            ;;
          "avx512")
            ARCH_FLAGS='-march=x86-64-v4 -mavx512f -mavx512cd'
            ;;
          *)
            ARCH_FLAGS='-march=x86-64-v2'
            ;;
        esac
        
        # åˆ›å»ºæ„å»ºé…ç½®è¡¥ä¸
        cat > build_patches/optimization.patch << 'EOF'
        diff --git a/build/config/compiler/BUILD.gn b/build/config/compiler/BUILD.gn
        index 1234567..abcdefg 100644
        --- a/build/config/compiler/BUILD.gn
        +++ b/build/config/compiler/BUILD.gn
        @@ -500,6 +500,12 @@ config("compiler") {
               "-fno-strict-aliasing",
             ]
           }
        +  
        +  # è‡ªå®šä¹‰ä¼˜åŒ–æ ‡å¿—
        +  if (is_linux && !is_chromeos) {
        +    cflags += [ "__ARCH_FLAGS__" ]
        +    cflags += [ "-O3", "-ffast-math" ]
        +  }
         }
        EOF
        
        # åº”ç”¨æ¶æ„ä¼˜åŒ–
        sed -i "s/__ARCH_FLAGS__/$ARCH_FLAGS/g" build_patches/optimization.patch
        
        # åº”ç”¨è¡¥ä¸ï¼ˆå¦‚æœå¤±è´¥åˆ™ç»§ç»­ï¼‰
        patch -p1 < build_patches/optimization.patch || echo "è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­æ„å»º"

    - name: Configure build
      run: |
        cd chromium-build/src
        
        # è®¾ç½®æ„å»ºå‚æ•°
        case "${OPTIMIZATION}" in
          "performance")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              use_pgo_profiles=true
              is_official_build=true
              optimize_for_size=false
              enable_stripping=true
              symbol_level=0
            '
            ;;
          "balanced")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              is_official_build=true
              optimize_for_size=false
              symbol_level=1
            '
            ;;
          "fast_build")
            OPTIMIZATION_FLAGS='
              is_debug=false
              optimize_for_size=true
              symbol_level=0
            '
            ;;
        esac
        
        # ç‰¹æ€§é…ç½®
        FEATURE_FLAGS=""
        IFS=',' read -ra FEATURES <<< "${ENABLE_FEATURES}"
        for feature in "${FEATURES[@]}"; do
          case "$feature" in
            "vaapi")
              FEATURE_FLAGS+=' use_vaapi=true'
              ;;
            "proprietary_codecs")
              FEATURE_FLAGS+=' proprietary_codecs=true ffmpeg_branding="Chrome"'
              ;;
            "hevc_decoding")
              FEATURE_FLAGS+=' enable_hevc_parser_and_hw_decoder=true'
              ;;
          esac
        done
        
        # ç”Ÿæˆæ„å»ºå‚æ•°
        cat > out/Default/args.gn << EOF
        # åŸºç¡€é…ç½®
        target_cpu = "x64"
        target_os = "linux"
        is_component_build = false
        is_debug = false
        
        # ä¼˜åŒ–é…ç½®
        ${OPTIMIZATION_FLAGS}
        
        # ç‰¹æ€§é…ç½®
        ${FEATURE_FLAGS}
        
        # ç¼–è¯‘å™¨é…ç½®
        is_clang = true
        use_lld = true
        use_gold = false
        
        # ç³»ç»Ÿé›†æˆ
        use_gtk = true
        use_system_harfbuzz = false
        use_system_libdrm = false
        
        # ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½
        enable_nacl = false
        enable_remoting = false
        enable_google_apis = false
        google_api_key = ""
        google_default_client_id = ""
        google_default_client_secret = ""
        
        # å“ç‰Œå’Œæ›´æ–°
        chrome_pgo_phase = 0
        enable_update_notification = false
        enable_crash_component = false
        
        # åª’ä½“æ”¯æŒ
        enable_widevine = true
        bundle_widevine_cdm = false
        EOF
        
        echo "=== æ„å»ºé…ç½® ==="
        cat out/Default/args.gn
        
        # ç”Ÿæˆæ„å»ºæ–‡ä»¶
        gn gen out/Default

    - name: Build Chromium
      run: |
        cd chromium-build/src
        
        echo "å¼€å§‹æ„å»º Chromium..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # è®¾ç½® ccache
        export CCACHE_BASEDIR=$(pwd)
        ccache --zero-stats
        
        # æ„å»ºä¸»ç›®æ ‡
        ninja -C out/Default chrome chrome_sandbox chromedriver
        
        echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"
        
        # æ˜¾ç¤º ccache ç»Ÿè®¡
        ccache --show-stats
        
        # éªŒè¯æ„å»ºäº§ç‰©
        ls -la out/Default/chrome*
        file out/Default/chrome
        
        # æ£€æŸ¥ä¾èµ–
        ldd out/Default/chrome | head -10

    - name: Build RPM package
      run: |
        echo "å‡†å¤‡æ„å»º RPM åŒ…..."
        
        FULL_VERSION="${PACKAGE_VERSION}.${BUILD_DATE}"
        RPM_NAME="chromium-clang"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        mkdir -p rpm-package/{SOURCES,SPECS,BUILD,BUILDROOT,RPMS,SRPMS}
        cd rpm-package
        
        # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ° SOURCES
        cd ../chromium-build/src
        tar -czf ../../rpm-package/SOURCES/${RPM_NAME}-${FULL_VERSION}.tar.gz \
          --transform "s,^,${RPM_NAME}-${FULL_VERSION}/," \
          out/Default/chrome \
          out/Default/chrome_sandbox \
          out/Default/chromedriver \
          out/Default/*.pak \
          out/Default/locales \
          out/Default/resources
        
        cd ../../rpm-package
        
        # åˆ›å»º RPM spec æ–‡ä»¶
        cat > SPECS/${RPM_NAME}.spec << EOF
        %global __os_install_post %{nil}
        %global debug_package %{nil}
        %global __strip /bin/true
        
        Name: ${RPM_NAME}
        Version: ${FULL_VERSION}
        Release: 1
        Summary: Chromium web browser compiled with Clang/LLVM
        
        License: BSD-3-Clause AND LGPL-2.1+ AND Apache-2.0
        URL: https://github.com/RobRich999/Chromium_Clang
        Source0: %{name}-%{version}.tar.gz
        
        BuildArch: x86_64
        AutoReqProv: no
        
        # Fedora ä¾èµ–å…³ç³»
        Requires: alsa-lib >= 1.0.19
        Requires: at-spi2-atk
        Requires: at-spi2-core
        Requires: atk >= 2.2.0
        Requires: cairo >= 1.6
        Requires: cups-libs
        Requires: dbus >= 1.6
        Requires: expat
        Requires: fontconfig >= 2.7.0
        Requires: freetype >= 2.4.2
        Requires: gdk-pixbuf2 >= 2.22.0
        Requires: glib2 >= 2.26
        Requires: glibc >= 2.17
        Requires: gtk3 >= 3.0
        Requires: libdrm
        Requires: libX11
        Requires: libXcomposite
        Requires: libXcursor
        Requires: libXdamage
        Requires: libXext
        Requires: libXfixes
        Requires: libXi
        Requires: libXrandr
        Requires: libXrender
        Requires: libXss
        Requires: libXtst
        Requires: libxcb
        Requires: libxkbcommon >= 0.5.0
        Requires: mesa-libgbm
        Requires: nspr >= 4.32
        Requires: nss >= 3.90
        Requires: pango >= 1.22.0
        
        %description
        Chromium compiled with Clang/LLVM and optimizations.
        
        %prep
        %setup -q
        
        %build
        # Already built
        
        %install
        rm -rf %{buildroot}
        
        # Create directory structure
        mkdir -p %{buildroot}/opt/chromium
        mkdir -p %{buildroot}/usr/bin
        mkdir -p %{buildroot}/usr/share/applications
        mkdir -p %{buildroot}/usr/share/pixmaps
        
        # Install files
        cp chrome %{buildroot}/opt/chromium/
        cp chrome_sandbox %{buildroot}/opt/chromium/
        cp chromedriver %{buildroot}/opt/chromium/
        cp *.pak %{buildroot}/opt/chromium/ || true
        cp -r locales %{buildroot}/opt/chromium/ || true
        cp -r resources %{buildroot}/opt/chromium/ || true
        
        # Set permissions
        chmod 4755 %{buildroot}/opt/chromium/chrome_sandbox
        chmod +x %{buildroot}/opt/chromium/chrome
        chmod +x %{buildroot}/opt/chromium/chromedriver
        
        # Create launcher script
        cat > %{buildroot}/usr/bin/chromium-clang << 'EOFSCRIPT'
        #!/bin/bash
        exec /opt/chromium/chrome "\$@"
        EOFSCRIPT
        chmod +x %{buildroot}/usr/bin/chromium-clang
        
        # Create desktop file
        cat > %{buildroot}/usr/share/applications/chromium-clang.desktop << 'EOFDESKTOP'
        [Desktop Entry]
        Version=1.0
        Name=Chromium Clang
        GenericName=Web Browser
        Comment=Access the Internet (Optimized Build)
        Exec=chromium-clang %U
        Terminal=false
        Icon=chromium-clang
        Type=Application
        Categories=Network;WebBrowser;
        MimeType=text/html;text/xml;application/xhtml+xml;
        StartupNotify=true
        EOFDESKTOP
        
        %files
        %defattr(-,root,root,-)
        /opt/chromium/*
        /usr/bin/chromium-clang
        /usr/share/applications/chromium-clang.desktop
        
        %changelog
        * $(date "+%a %b %d %Y") GitHub Actions <actions@github.com> - ${FULL_VERSION}-1
        - Automated build from source
        - Optimizations: ${OPTIMIZATION}, ${TARGET_ARCH}
        EOF
        
        # ä½¿ç”¨ Fedora å®¹å™¨æ„å»º RPM
        echo "ä½¿ç”¨ Fedora å®¹å™¨æ„å»º RPM..."
        
        podman run --rm -v $(pwd):/workspace:Z \
          -w /workspace \
          registry.fedoraproject.org/fedora:39 \
          bash -c "
            dnf install -y rpm-build rpm-devel
            rpmbuild --define '_topdir /workspace' -ba SPECS/${RPM_NAME}.spec
          "
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        find RPMS -name "*.rpm" -ls
        
        # å¤åˆ¶ RPM åˆ°å·¥ä½œç›®å½•æ ¹
        cp RPMS/*/*.rpm ../

    - name: Test RPM package
      run: |
        echo "æµ‹è¯• RPM åŒ…..."
        
        # æ‰¾åˆ°æ„å»ºçš„ RPM
        RPM_FILE=$(find . -name "chromium-clang-*.rpm" | head -1)
        
        if [ -f "$RPM_FILE" ]; then
          echo "éªŒè¯ RPM åŒ…: $RPM_FILE"
          
          # ä½¿ç”¨å®¹å™¨æµ‹è¯• RPM åŒ…
          podman run --rm -v $(pwd):/workspace:Z \
            -w /workspace \
            registry.fedoraproject.org/fedora:39 \
            bash -c "
              rpm -qip $RPM_FILE
              echo '--- æ–‡ä»¶åˆ—è¡¨ ---'
              rpm -qlp $RPM_FILE | head -20
              echo '--- ä¾èµ–æ£€æŸ¥ ---'
              rpm -qRp $RPM_FILE | head -10
            "
          
        else
          echo "æœªæ‰¾åˆ° RPM åŒ…æ–‡ä»¶"
          exit 1
        fi

    - name: Create release artifacts
      run: |
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        cat > "release-notes.md" << EOF
        # Chromium Clang RPM Build
        
        **æ„å»ºä¿¡æ¯**
        - Chromium ç‰ˆæœ¬: ${CHROMIUM_VERSION}
        - ä¿®è®¢ç‰ˆæœ¬: r${CHROMIUM_REVISION}
        - æ„å»ºæ—¥æœŸ: ${BUILD_DATE}
        - ä¼˜åŒ–çº§åˆ«: ${OPTIMIZATION}
        - ç›®æ ‡æ¶æ„: ${TARGET_ARCH}
        - å¯ç”¨ç‰¹æ€§: ${ENABLE_FEATURES}
        
        **æ€§èƒ½ä¼˜åŒ–**
        - ğŸš€ Clang/LLVM ç¼–è¯‘å™¨
        - ğŸ”— ThinLTO é“¾æ¥æ—¶ä¼˜åŒ–
        - ğŸ“Š PGO é…ç½®æ–‡ä»¶å¼•å¯¼ä¼˜åŒ–
        - ğŸ—ï¸ ${TARGET_ARCH} CPU æŒ‡ä»¤é›†ä¼˜åŒ–
        - âš¡ Fast-math æµ®ç‚¹ä¼˜åŒ–
        - ğŸ¯ è‡ªå®šä¹‰ç¼–è¯‘æ ‡å¿—
        
        **å®‰è£…æ–¹æ³•**
        
        ### Fedora/RHEL/CentOS:
        \`\`\`bash
        sudo dnf install ./chromium-clang-*.rpm
        \`\`\`
        
        ### openSUSE:
        \`\`\`bash
        sudo zypper install ./chromium-clang-*.rpm
        \`\`\`
        
        **ä½¿ç”¨æ–¹æ³•**
        \`\`\`bash
        chromium-clang
        \`\`\`
        
        **æ³¨æ„äº‹é¡¹**
        - éœ€è¦æ”¯æŒ ${TARGET_ARCH} æŒ‡ä»¤é›†çš„ CPU
        - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´è¿›è¡Œä¼˜åŒ–
        - å¦‚æœ‰é—®é¢˜è¯·æ£€æŸ¥ç³»ç»Ÿä¾èµ–æ˜¯å¦å®Œæ•´
        
        **æ„å»ºç¯å¢ƒ**
        - æ„å»ºç³»ç»Ÿ: Ubuntu $(lsb_release -rs)
        - ç¼–è¯‘å™¨: Clang $(clang --version | head -1)
        - æ„å»ºæ—¶é—´: çº¦ $(( SECONDS / 3600 )) å°æ—¶ $(( (SECONDS % 3600) / 60 )) åˆ†é’Ÿ
        EOF
        
        # åˆ›å»ºæ ¡éªŒå’Œ
        sha256sum *.rpm > checksums.sha256
        
        echo "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ:"
        ls -la *.rpm release-notes.md checksums.sha256

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chromium-clang-rpm-${{ env.PACKAGE_VERSION }}-${{ env.BUILD_DATE }}
        path: |
          *.rpm
          release-notes.md
          checksums.sha256
        retention-days: 30

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.PACKAGE_VERSION }}-${{ env.TARGET_ARCH }}-${{ env.BUILD_DATE }}
        name: Chromium Clang ${{ env.CHROMIUM_VERSION }} (${{ env.TARGET_ARCH }})
        body_path: release-notes.md
        files: |
          *.rpm
          checksums.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      if: always()
      run: |
        # æ¸…ç†æ„å»ºç¼“å­˜
        ccache --clear
        
        # æ¸…ç†å¤§å‹ä¸´æ—¶æ–‡ä»¶
        rm -rf chromium-build/src/out/Default/*.o
        rm -rf chromium-build/src/out/Default/obj
        
        echo "æ„å»ºå®Œæˆï¼Œæ¸…ç†å®Œæ¯•"
