name: Build Chromium Clang RPM from Source

on:
  workflow_dispatch:
    inputs:
      chromium_version:
        description: 'Chromium 版本 (例如: 142.0.7413.0)'
        required: true
        type: string
      revision:
        description: 'Chromium revision (例如: 1515249)'
        required: true
        type: string
      optimization_level:
        description: '优化级别'
        required: true
        default: 'performance'
        type: choice
        options:
        - 'performance'  # 最高性能
        - 'balanced'     # 平衡性能和构建时间
        - 'fast_build'   # 快速构建
      target_arch:
        description: 'CPU 架构优化'
        required: true
        default: 'avx2'
        type: choice
        options:
        - 'avx'
        - 'avx2'
        - 'avx512'
        - 'generic'
      enable_features:
        description: '启用的特性 (逗号分隔)'
        required: false
        default: 'vaapi,proprietary_codecs,hevc_decoding'
        type: string

  schedule:
    - cron: '0 2 * * 1'  # 每周一凌晨 2 点检查构建

env:
  # 构建配置
  CHROMIUM_VERSION: ${{ github.event.inputs.chromium_version || '142.0.7413.0' }}
  CHROMIUM_REVISION: ${{ github.event.inputs.revision || '1515249' }}
  OPTIMIZATION: ${{ github.event.inputs.optimization_level || 'performance' }}
  TARGET_ARCH: ${{ github.event.inputs.target_arch || 'avx2' }}
  ENABLE_FEATURES: ${{ github.event.inputs.enable_features || 'vaapi,proprietary_codecs,hevc_decoding' }}
  
  # 编译环境
  CCACHE_DIR: /tmp/ccache
  CCACHE_MAXSIZE: 10G
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-chromium-rpm:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 小时超时
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        # 设置变量
        echo "PACKAGE_VERSION=${CHROMIUM_VERSION}-r${CHROMIUM_REVISION}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORKER_COUNT=$(nproc)" >> $GITHUB_ENV
        
        # 显示构建信息
        echo "=== 构建配置 ==="
        echo "Chromium 版本: ${CHROMIUM_VERSION}"
        echo "修订版本: r${CHROMIUM_REVISION}"
        echo "优化级别: ${OPTIMIZATION}"
        echo "目标架构: ${TARGET_ARCH}"
        echo "启用特性: ${ENABLE_FEATURES}"
        echo "CPU 核心数: $(nproc)"
        echo "可用内存: $(free -h | grep Mem | awk '{print $2}')"

    - name: Install build dependencies
      run: |
        # 更新包管理器
        sudo apt-get update
        
        # 安装基础构建工具
        sudo apt-get install -y \
          build-essential \
          git \
          python3 \
          python3-pip \
          curl \
          wget \
          unzip \
          rpm \
          alien \
          ccache \
          ninja-build \
          pkg-config \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm-dev \
          libxkbcommon-dev \
          libxss-dev \
          libasound2-dev \
          libatspi2.0-dev \
          libgtk-3-dev \
          libgbm-dev \
          libxrandr-dev
        
        # 安装 RPM 构建工具
        sudo apt-get install -y rpm-build rpmlint
        
        # 设置 Python 依赖
        pip3 install --user requests

    - name: Setup Chromium build tools
      run: |
        # 创建工作目录
        mkdir -p chromium-build
        cd chromium-build
        
        # 下载 depot_tools
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        export PATH="$(pwd)/depot_tools:$PATH"
        echo "$(pwd)/depot_tools" >> $GITHUB_PATH
        
        # 配置 Git（depot_tools 需要）
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
        git config --global core.filemode false
        git config --global color.ui true

    - name: Download Chromium source
      run: |
        cd chromium-build
        
        # 创建 gclient 配置
        cat > .gclient << EOF
        solutions = [
          {
            "name": "src",
            "url": "https://chromium.googlesource.com/chromium/src.git",
            "managed": False,
            "custom_deps": {},
            "custom_vars": {
              "checkout_configuration": "default",
            },
          },
        ]
        target_os = ["linux"]
        EOF
        
        # 同步源码到特定版本
        echo "开始下载 Chromium 源码..."
        gclient sync --nohooks --no-history --revision=src@${CHROMIUM_REVISION}
        
        cd src
        # 运行构建前的钩子
        gclient runhooks

    - name: Apply optimization patches
      run: |
        cd chromium-build/src
        
        # 应用来自 RobRich999 项目的优化补丁
        echo "应用编译优化补丁..."
        
        # 创建优化补丁目录
        mkdir -p build_patches
        
        # CPU 架构优化
        case "${TARGET_ARCH}" in
          "avx")
            ARCH_FLAGS='-march=x86-64-v3 -mavx -mfma'
            ;;
          "avx2") 
            ARCH_FLAGS='-march=x86-64-v3 -mavx2 -mfma'
            ;;
          "avx512")
            ARCH_FLAGS='-march=x86-64-v4 -mavx512f -mavx512cd'
            ;;
          *)
            ARCH_FLAGS='-march=x86-64-v2'
            ;;
        esac
        
        # 创建构建配置补丁
        cat > build_patches/optimization.patch << 'EOF'
        diff --git a/build/config/compiler/BUILD.gn b/build/config/compiler/BUILD.gn
        index 1234567..abcdefg 100644
        --- a/build/config/compiler/BUILD.gn
        +++ b/build/config/compiler/BUILD.gn
        @@ -500,6 +500,12 @@ config("compiler") {
               "-fno-strict-aliasing",
             ]
           }
        +  
        +  # 自定义优化标志
        +  if (is_linux && !is_chromeos) {
        +    cflags += [ "__ARCH_FLAGS__" ]
        +    cflags += [ "-O3", "-ffast-math" ]
        +  }
         }
        EOF
        
        # 应用架构优化
        sed -i "s/__ARCH_FLAGS__/$ARCH_FLAGS/g" build_patches/optimization.patch
        
        # 应用补丁（如果失败则继续）
        patch -p1 < build_patches/optimization.patch || echo "补丁应用失败，继续构建"

    - name: Configure build
      run: |
        cd chromium-build/src
        
        # 设置构建参数
        case "${OPTIMIZATION}" in
          "performance")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              use_pgo_profiles=true
              is_official_build=true
              optimize_for_size=false
              enable_stripping=true
              symbol_level=0
            '
            ;;
          "balanced")
            OPTIMIZATION_FLAGS='
              use_thin_lto=true
              is_official_build=true
              optimize_for_size=false
              symbol_level=1
            '
            ;;
          "fast_build")
            OPTIMIZATION_FLAGS='
              is_debug=false
              optimize_for_size=true
              symbol_level=0
            '
            ;;
        esac
        
        # 特性配置
        FEATURE_FLAGS=""
        IFS=',' read -ra FEATURES <<< "${ENABLE_FEATURES}"
        for feature in "${FEATURES[@]}"; do
          case "$feature" in
            "vaapi")
              FEATURE_FLAGS+=' use_vaapi=true'
              ;;
            "proprietary_codecs")
              FEATURE_FLAGS+=' proprietary_codecs=true ffmpeg_branding="Chrome"'
              ;;
            "hevc_decoding")
              FEATURE_FLAGS+=' enable_hevc_parser_and_hw_decoder=true'
              ;;
          esac
        done
        
        # 生成构建参数
        cat > out/Default/args.gn << EOF
        # 基础配置
        target_cpu = "x64"
        target_os = "linux"
        is_component_build = false
        is_debug = false
        
        # 优化配置
        ${OPTIMIZATION_FLAGS}
        
        # 特性配置
        ${FEATURE_FLAGS}
        
        # 编译器配置
        is_clang = true
        use_lld = true
        use_gold = false
        
        # 系统集成
        use_gtk = true
        use_system_harfbuzz = false
        use_system_libdrm = false
        
        # 禁用不需要的功能
        enable_nacl = false
        enable_remoting = false
        enable_google_apis = false
        google_api_key = ""
        google_default_client_id = ""
        google_default_client_secret = ""
        
        # 品牌和更新
        chrome_pgo_phase = 0
        enable_update_notification = false
        enable_crash_component = false
        
        # 媒体支持
        enable_widevine = true
        bundle_widevine_cdm = false
        EOF
        
        echo "=== 构建配置 ==="
        cat out/Default/args.gn
        
        # 生成构建文件
        gn gen out/Default

    - name: Build Chromium
      run: |
        cd chromium-build/src
        
        echo "开始构建 Chromium..."
        echo "开始时间: $(date)"
        
        # 设置 ccache
        export CCACHE_BASEDIR=$(pwd)
        ccache --zero-stats
        
        # 构建主目标
        ninja -C out/Default chrome chrome_sandbox chromedriver
        
        echo "构建完成时间: $(date)"
        
        # 显示 ccache 统计
        ccache --show-stats
        
        # 验证构建产物
        ls -la out/Default/chrome*
        file out/Default/chrome
        
        # 检查依赖
        ldd out/Default/chrome | head -10

    - name: Create RPM package structure
      run: |
        echo "创建 RPM 包结构..."
        
        # 创建 RPM 构建环境
        mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
        
        # 设置版本信息
        FULL_VERSION="${PACKAGE_VERSION}.${BUILD_DATE}"
        RPM_NAME="chromium-clang"
        
        # 创建安装目录结构
        INSTALL_ROOT="~/rpmbuild/BUILDROOT/${RPM_NAME}-${FULL_VERSION}-1.x86_64"
        mkdir -p "${INSTALL_ROOT}"/{opt/chromium,usr/{bin,share/{applications,pixmaps,man/man1}}}
        
        cd chromium-build/src
        
        # 复制主要文件
        cp out/Default/chrome "${INSTALL_ROOT}/opt/chromium/"
        cp out/Default/chrome_sandbox "${INSTALL_ROOT}/opt/chromium/"
        cp out/Default/chromedriver "${INSTALL_ROOT}/opt/chromium/"
        
        # 复制资源文件
        cp out/Default/*.pak "${INSTALL_ROOT}/opt/chromium/" || true
        cp -r out/Default/locales "${INSTALL_ROOT}/opt/chromium/" || true
        cp -r out/Default/resources "${INSTALL_ROOT}/opt/chromium/" || true
        
        # 设置正确的权限
        chmod 4755 "${INSTALL_ROOT}/opt/chromium/chrome_sandbox"
        chmod +x "${INSTALL_ROOT}/opt/chromium/chrome"
        chmod +x "${INSTALL_ROOT}/opt/chromium/chromedriver"
        
        # 创建启动脚本
        cat > "${INSTALL_ROOT}/usr/bin/chromium-clang" << 'EOF'
        #!/bin/bash
        exec /opt/chromium/chrome "$@"
        EOF
        chmod +x "${INSTALL_ROOT}/usr/bin/chromium-clang"
        
        # 创建桌面文件
        cat > "${INSTALL_ROOT}/usr/share/applications/chromium-clang.desktop" << EOF
        [Desktop Entry]
        Version=1.0
        Name=Chromium Clang
        GenericName=Web Browser
        Comment=Access the Internet (Optimized Build)
        Exec=chromium-clang %U
        Terminal=false
        Icon=chromium-clang
        Type=Application
        Categories=Network;WebBrowser;
        MimeType=text/html;text/xml;application/xhtml+xml;x-scheme-handler/http;x-scheme-handler/https;
        StartupNotify=true
        EOF
        
        # 复制图标（如果存在）
        if [ -f chrome/app/theme/chromium/product_logo_128.png ]; then
          cp chrome/app/theme/chromium/product_logo_128.png "${INSTALL_ROOT}/usr/share/pixmaps/chromium-clang.png"
        fi
        
        # 创建 man 页面
        cat > "${INSTALL_ROOT}/usr/share/man/man1/chromium-clang.1" << EOF
        .TH CHROMIUM-CLANG 1
        .SH NAME
        chromium-clang \- Chromium web browser (optimized build)
        .SH SYNOPSIS
        .B chromium-clang
        [OPTIONS] [URL]
        .SH DESCRIPTION
        Chromium is an open-source web browser, compiled with Clang/LLVM for optimal performance.
        This build includes ThinLTO, PGO optimizations, and ${TARGET_ARCH} CPU optimizations.
        EOF
        
        echo "包结构创建完成"

    - name: Build RPM package
      run: |
        cd ~/rpmbuild
        
        FULL_VERSION="${PACKAGE_VERSION}.${BUILD_DATE}"
        RPM_NAME="chromium-clang"
        
        # 创建 RPM spec 文件
        cat > SPECS/${RPM_NAME}.spec << EOF
        %global __os_install_post %{nil}
        %global debug_package %{nil}
        %global __strip /bin/true
        
        Name: ${RPM_NAME}
        Version: ${FULL_VERSION}
        Release: 1
        Summary: Chromium web browser compiled with Clang/LLVM
        
        License: BSD-3-Clause AND LGPL-2.1+ AND Apache-2.0 AND IJG AND MIT AND GPL-2.0+ AND ISC AND OpenSSL AND (MPL-1.1 OR GPL-2.0 OR LGPL-2.0)
        URL: https://github.com/RobRich999/Chromium_Clang
        Source0: %{name}-%{version}.tar.gz
        
        BuildArch: x86_64
        AutoReqProv: no
        
        # Fedora 依赖关系
        Requires: alsa-lib >= 1.0.19
        Requires: at-spi2-atk
        Requires: at-spi2-core
        Requires: atk >= 2.2.0
        Requires: cairo >= 1.6
        Requires: cups-libs
        Requires: dbus >= 1.6
        Requires: expat
        Requires: fontconfig >= 2.7.0
        Requires: freetype >= 2.4.2
        Requires: gdk-pixbuf2 >= 2.22.0
        Requires: glib2 >= 2.26
        Requires: glibc >= 2.17
        Requires: gtk3 >= 3.0
        Requires: libdrm
        Requires: libX11
        Requires: libXcomposite
        Requires: libXcursor
        Requires: libXdamage
        Requires: libXext
        Requires: libXfixes
        Requires: libXi
        Requires: libXrandr
        Requires: libXrender
        Requires: libXss
        Requires: libXtst
        Requires: libxcb
        Requires: libxkbcommon >= 0.5.0
        Requires: mesa-libgbm
        Requires: nspr >= 4.32
        Requires: nss >= 3.90
        Requires: pango >= 1.22.0
        
        # 推荐的可选依赖
        Recommends: liberation-fonts
        Recommends: google-noto-fonts
        Recommends: mesa-dri-drivers
        Recommends: pulseaudio-libs
        
        %description
        Chromium is the open-source project behind Google Chrome. This build is compiled
        with the Clang/LLVM compiler and includes various performance optimizations:
        
        - ThinLTO (Thin Link Time Optimization)
        - PGO (Profile-Guided Optimization) 
        - CPU-specific optimizations for ${TARGET_ARCH}
        - Fast-math optimizations
        - Custom build flags for enhanced performance
        
        Optimization level: ${OPTIMIZATION}
        Target architecture: ${TARGET_ARCH}
        Enabled features: ${ENABLE_FEATURES}
        Build date: ${BUILD_DATE}
        Chromium version: ${CHROMIUM_VERSION} (r${CHROMIUM_REVISION})
        
        %prep
        # 文件已准备好
        
        %build
        # 已构建完成
        
        %install
        # 文件已安装
        
        %files
        %defattr(-,root,root,-)
        /opt/chromium/
        /usr/bin/chromium-clang
        /usr/share/applications/chromium-clang.desktop
        /usr/share/pixmaps/chromium-clang.png
        /usr/share/man/man1/chromium-clang.1*
        
        %post
        # 更新桌面数据库
        if [ -x /usr/bin/update-desktop-database ]; then
          /usr/bin/update-desktop-database /usr/share/applications &> /dev/null || :
        fi
        
        # 更新图标缓存
        if [ -x /usr/bin/gtk-update-icon-cache ]; then
          /usr/bin/gtk-update-icon-cache /usr/share/pixmaps &> /dev/null || :
        fi
        
        %postun
        if [ \$1 -eq 0 ] ; then
          if [ -x /usr/bin/update-desktop-database ]; then
            /usr/bin/update-desktop-database /usr/share/applications &> /dev/null || :
          fi
          if [ -x /usr/bin/gtk-update-icon-cache ]; then
            /usr/bin/gtk-update-icon-cache /usr/share/pixmaps &> /dev/null || :
          fi
        fi
        
        %changelog
        * $(date "+%a %b %d %Y") GitHub Actions <actions@github.com> - ${FULL_VERSION}-1
        - Automated build from Chromium source
        - Clang/LLVM compiled with ${OPTIMIZATION} optimization
        - CPU optimizations: ${TARGET_ARCH}
        - Features: ${ENABLE_FEATURES}
        - Based on Chromium ${CHROMIUM_VERSION} (r${CHROMIUM_REVISION})
        EOF
        
        echo "=== RPM Spec 文件 ==="
        cat SPECS/${RPM_NAME}.spec
        
        # 构建 RPM
        echo "开始构建 RPM 包..."
        rpmbuild -bb SPECS/${RPM_NAME}.spec
        
        # 检查构建结果
        find RPMS -name "*.rpm" -ls
        
        # 验证包
        for rpm in RPMS/x86_64/*.rpm; do
          echo "=== 验证 $rpm ==="
          rpm -qip "$rpm"
          echo ""
          echo "文件列表:"
          rpm -qlp "$rpm" | head -20
          echo "..."
        done

    - name: Test RPM package
      run: |
        echo "测试 RPM 包..."
        
        cd ~/rpmbuild
        
        # 找到构建的 RPM
        RPM_FILE=$(find RPMS -name "chromium-clang-*.rpm" | head -1)
        
        if [ -f "$RPM_FILE" ]; then
          echo "测试安装到临时目录..."
          mkdir -p /tmp/test-install
          cd /tmp/test-install
          
          # 提取包内容测试
          rpm2cpio "$RPM_FILE" | cpio -idmv
          
          echo "验证关键文件..."
          ls -la opt/chromium/chrome
          ls -la usr/bin/chromium-clang
          
          # 测试二进制文件
          echo "测试主程序..."
          opt/chromium/chrome --version || echo "版本检查失败，可能缺少依赖"
          
          # 检查依赖
          echo "检查库依赖..."
          ldd opt/chromium/chrome | grep "not found" || echo "依赖检查通过"
          
        else
          echo "未找到 RPM 包文件"
          exit 1
        fi

    - name: Create release artifacts
      run: |
        cd ~/rpmbuild
        
        # 复制 RPM 到工作目录
        cp RPMS/x86_64/*.rpm "$GITHUB_WORKSPACE/"
        
        # 创建发布说明
        cat > "$GITHUB_WORKSPACE/release-notes.md" << EOF
        # Chromium Clang RPM Build
        
        **构建信息**
        - Chromium 版本: ${CHROMIUM_VERSION}
        - 修订版本: r${CHROMIUM_REVISION}
        - 构建日期: ${BUILD_DATE}
        - 优化级别: ${OPTIMIZATION}
        - 目标架构: ${TARGET_ARCH}
        - 启用特性: ${ENABLE_FEATURES}
        
        **性能优化**
        - 🚀 Clang/LLVM 编译器
        - 🔗 ThinLTO 链接时优化
        - 📊 PGO 配置文件引导优化
        - 🏗️ ${TARGET_ARCH} CPU 指令集优化
        - ⚡ Fast-math 浮点优化
        - 🎯 自定义编译标志
        
        **安装方法**
        
        ### Fedora/RHEL/CentOS:
        \`\`\`bash
        sudo dnf install ./chromium-clang-*.rpm
        \`\`\`
        
        ### openSUSE:
        \`\`\`bash
        sudo zypper install ./chromium-clang-*.rpm
        \`\`\`
        
        **使用方法**
        \`\`\`bash
        chromium-clang
        \`\`\`
        
        **注意事项**
        - 需要支持 ${TARGET_ARCH} 指令集的 CPU
        - 首次运行可能需要较长时间进行优化
        - 如有问题请检查系统依赖是否完整
        
        **构建环境**
        - 构建系统: Ubuntu $(lsb_release -rs)
        - 编译器: Clang $(clang --version | head -1)
        - 构建时间: 约 $(( SECONDS / 3600 )) 小时 $(( (SECONDS % 3600) / 60 )) 分钟
        EOF
        
        # 创建校验和
        sha256sum *.rpm > checksums.sha256
        
        echo "发布文件准备完成:"
        ls -la *.rpm release-notes.md checksums.sha256

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chromium-clang-rpm-${{ env.PACKAGE_VERSION }}-${{ env.BUILD_DATE }}
        path: |
          *.rpm
          release-notes.md
          checksums.sha256
        retention-days: 30

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.PACKAGE_VERSION }}-${{ env.TARGET_ARCH }}-${{ env.BUILD_DATE }}
        name: Chromium Clang ${{ env.CHROMIUM_VERSION }} (${{ env.TARGET_ARCH }})
        body_path: release-notes.md
        files: |
          *.rpm
          checksums.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      if: always()
      run: |
        # 清理构建缓存
        ccache --clear
        
        # 清理大型临时文件
        rm -rf chromium-build/src/out/Default/*.o
        rm -rf chromium-build/src/out/Default/obj
        
        echo "构建完成，清理完毕"
